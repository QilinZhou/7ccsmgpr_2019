<!DOCTYPE html>
<html>
	<head>
		<title>Deadline Fighters File Synchroniser</title>
		<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
		<script src="https://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	</head>
	<body onload = "listObjectsinServer()">

		<ul id="objectList" ></ul>

		<br>

		<button id="sync-button">Sync</button>

		<br>

		<p id="results">
		
		
			<script type="text/javascript">

				/* Global variables */

				var xhr = new XMLHttpRequest();
				var url = "http://10.40.238.245:80"; //static IP for machine running python server
				var data;
				var syncDir; // Sync directory
				var logDir; // Log directory
				
				
				/* HTML element variables */
				var fileChooser = document.getElementById('file-chooser');
				var upload = document.getElementById('upload-button');
				var download = document.getElementById('download-button');
				var del = document.getElementById('delete-button');
				var rename = document.getElementById('rename-button');
				var edit = document.getElementById('edit-button');
				var sync = document.getElementById('sync-button');
				var results = document.getElementById('results');

				/* Required node modules */
				const fs = require('fs');
				const httpreq = require('httpreq');
				const os = require('os');
				const chokidar = require('chokidar');
				const FormData = require('form-data');
			
				/* Create folder for sync and log */
				var isMacLike = navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)?true:false;
				if(isMacLike){
					syncDir = os.homedir()+"/deadlinefighters/";
					logDir = os.homedir()+"/deadlineFightersLogs/";
					if(!fs.existsSync(syncDir)){
					  fs.mkdir(syndDdir,function(err){

						 if (err) {
						   return console.error(err);
						 }
						 console.log("Sync folder created successfully.");
					  });
					}
					else{
						console.log("Sync folder already present");
					}

					if(!fs.existsSync(logDir)){
					  fs.mkdir(logDir,function(err){

						 if (err) {
						   return console.error(err);
						 }
						 console.log("Log folder created successfully.");
					  });
					}
					else{
						console.log("Log folder already present")
					}
				}
				else{
					syncDir = "D:\\deadlinefighters\\";
					logDir = "D:\\deadlineFightersLogs\\"
					if(!fs.existsSync(syncDir)){		
						fs.mkdir(syncDir,function(err){

						   if (err) {
							   return console.error(err);
						   }
						   console.log("Sync folder created successfully.");
						});
					}
					else{
						console.log("Sync folder already present");
					}

					if(!fs.existsSync(logDir)){		
						fs.mkdir(logDir,function(err){

						   if (err) {
							   return console.error(err);
						   }
						   console.log("Log folder created successfully.");
						});
					}
					else{
						console.log("Log folder already present")
					}
				}


				function loadDoc(filepath) {
					var xhttp = new XMLHttpRequest();
					xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
							return this.responseText;
						}
					};
					xhttp.open("GET", filepath, true);
					xhttp.send();
				}

				/* HTTP calls to Python server */
				function listObjectsinServer(){
					console.log("listObjectsinServer called");
					xhr.open("POST", url, true);

					xhr.setRequestHeader("Content-Type", "application/json");
					results.innerHTML = '';

					data = JSON.stringify({"operation": "listAll", "bucketName": "deadlinefighters", "fileDetails": {"fileName": "All"}});

					xhr.onreadystatechange = function () {

							if (xhr.readyState === 4 && xhr.status === 200) {
								$('#objectList').empty();
								jsonResponse = JSON.parse(xhr.responseText);
									listAllJson = jsonResponse['listAll'];
									for(var i = 0; i<listAllJson.length;i++) {
										var obj = listAllJson[i];
										if(obj.hasOwnProperty('fileName')){
											$('#objectList').append("<button  id="+i+" value= '"+obj.fileName+"'>"+obj.fileName+"</button><br>");
										}
									}
								}
							return;
					};
					xhr.send(data);
					return; 
				}
				
				/* File Watcher */
				var watcher = chokidar.watch(syncDir, {
								  ignored: /[\/\\]\./,
								  persistent: true
							  });

				watcher
				  .on('add', function(dir) {
						console.log('File', dir, 'has been added');
						xhr.open("POST", url, true);
						xhr.setRequestHeader("Content-Type", "application/json");
						results.innerHTML = '';

						var fileName = dir.replace(/^.*[\\\/]/, '');
						data = JSON.stringify({"operation": "uploadFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": fileName}});

						xhr.onreadystatechange = function () {
							if (xhr.readyState === 4 && xhr.status === 200) {
								jsonResponse = JSON.parse(xhr.responseText);

								var xhrUpload = new XMLHttpRequest ();
								xhrUpload.open("PUT", jsonResponse["url"], true);
								xhrUpload.send(fs.readFileSync(dir));

								listObjectsinServer();
							}
							else if(xhr.status!=200) {
								results.innerHTML = 'ERROR!';
							}
						};
						xhr.send(data);
						
				  })
				  .on('addDir', function(dir) {
						console.log('Directory', dir, 'has been added');
				  })
				  .on('change', function(dir) {
						console.log('File', dir, 'has been edited');
						xhr.open("POST", url, true);
						xhr.setRequestHeader("Content-Type", "application/json");
						results.innerHTML = '';

						var fileName = dir.replace(/^.*[\\\/]/, '');
						data = JSON.stringify({"operation": "uploadFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": fileName}});

						xhr.onreadystatechange = function () {
							if (xhr.readyState === 4 && xhr.status === 200) {
								jsonResponse = JSON.parse(xhr.responseText);

								var xhrUpload = new XMLHttpRequest ();
								xhrUpload.open("PUT", jsonResponse["url"], true);
								xhrUpload.send(fs.readFileSync(dir));
								 
								listObjectsinServer();
							}
							else if(xhr.status!=200) {
								results.innerHTML = 'ERROR!';
							}
						};
						xhr.send(data);
				  })
				  .on('unlink', function(dir) {
						console.log('File', dir, 'has been removed');

						xhr.open("POST", url, true);

						xhr.setRequestHeader("Content-Type", "application/json");
						results.innerHTML = '';

						data = JSON.stringify({"operation": "deleteFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": dir.replace(/^.*[\\\/]/, '')}});

						xhr.onreadystatechange = function () {

							if (xhr.readyState === 4 && xhr.status === 200) {
								jsonResponse = JSON.parse(xhr.responseText);
								$.ajax({
									url: jsonResponse["url"],    //Your api url
									type: 'DELETE',   //type is any HTTP method
									data: dir,
									success: function () {
										results.innerHTML = dir+" deleted!"
									}
								});
								listObjectsinServer();
							}
							else if(xhr.status!=200) {
								results.innerHTML = 'ERROR!';
							}
						};
						xhr.send(data);

				  })
				  .on('unlinkDir', function(dir) {
					   console.log('Directory', dir, 'has been removed');
				  })
				  .on('error', function(error) {
					   console.log('Error happened', error);
				  })
				  .on('raw', function(event, dir, details) {
					   // This event should be triggered everytime something happens.
					   console.log('Raw event info:', event, dir, details);
				  }); 
				
			  
			  
					//sync: pull before push
					$(sync).click(function(){

						console.log("Entered syncbtn");

						xhr.open("POST", url, true);

						xhr.setRequestHeader("Content-Type", "application/json");
						results.innerHTML = '';

						data = JSON.stringify({"operation": "syncAll", "bucketName": "deadlinefighters", "fileDetails": {"fileName": "All"}});

						xhr.onreadystatechange = function () {

							if (xhr.readyState === 4 && xhr.status === 200) {
								jsonResponse = JSON.parse(xhr.responseText);
								syncAllJson = jsonResponse['syncAll'];
								for(i in syncAllJson['downloadAll']) {
									var obj = syncAllJson.downloadAll[i];
									httpreq.download(obj.url, dir+obj.fileName, obj.fileName, function (err, progress){
										if (err) 
											return console.log(err);
										console.log(progress);

									}, function(err,res){
										if (err)
											return console.log(err);
										console.log(obj.fileName+" downloaded");
									});
								}

								for(i in syncAllJson.uploadAll) {
									var obj = syncAllJson.uploadAll[i];
									fs.readFile(obj[obj.fileName], 'utf8', function(err, fileData) {  
										if (err) 
											throw err;
										$.ajax({
											url: obj.url,    //Your api url
											type: 'PUT',   //type is any HTTP method
											data: fileData,
											async:false,
											retryLimit: 3,
											success: function () {
												results.innerHTML = obj.fileName+" uploaded!";
											},
											error: function(){
												results.innerHTML = obj.fileName+" upload failed";
											}
										});
									});
								}	
							}
							else if(xhr.status!=200) {
								results.innerHTML = 'ERROR!';
							}
						};
						xhr.send(data); 
					});
			  
					//Select a file to download or delete
					$('#objectList').on("click",'button',function(){
						var i = $(this).attr('id');
						var downloadbtn = $("<button id='download'></button>").text("download");
						var deletebtn = $("<button id='delete'></button>").text("delete");
						$(downloadbtn).dialog();
						$(deletebtn).dialog();

						var file = $(this).val(); 

						var filePath = '/deadlinefighters'+'/' + file; 

						$(downloadbtn).click(function(){

								console.log("Entered downloadbtn");

								xhr.open("POST", url, true);

								xhr.setRequestHeader("Content-Type", "application/json");
								results.innerHTML = '';

								data = JSON.stringify({"operation": "downloadFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": file}});

								xhr.onreadystatechange = function () {

									if (xhr.readyState === 4 && xhr.status === 200) {
										jsonResponse = JSON.parse(xhr.responseText);
										httpreq.download(jsonResponse["url"], syncDir+file, file, function (err, progress){
											if (err) 
												return console.log(err);
											console.log(progress);

										}, function(err,res){
											if (err)
												return console.log(err);
											console.log(res);
										});
										listObjectsinServer();
									}
									else if(xhr.status!=200) {
										results.innerHTML = 'ERROR!';
									}
								};
								xhr.send(data);
						});

				  
						$(deletebtn).click(function(){

							xhr.open("POST", url, true);

							xhr.setRequestHeader("Content-Type", "application/json");
							results.innerHTML = '';

							data = JSON.stringify({"operation": "deleteFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": file}});

							xhr.onreadystatechange = function () {

								if (xhr.readyState === 4 && xhr.status === 200) {
									jsonResponse = JSON.parse(xhr.responseText);
									$.ajax({
										url: jsonResponse["url"],    //Your api url
										type: 'DELETE',   //type is any HTTP method
										data: syncDir,
										success: function () {
											results.innerHTML = file+" deleted!"
										}
									});
									listObjectsinServer();
								}
								else if(xhr.status!=200) {
									results.innerHTML = 'ERROR!';
								}
							};
							xhr.send(data);

						});
					});
		
			</script>	
	</body>
</html>
