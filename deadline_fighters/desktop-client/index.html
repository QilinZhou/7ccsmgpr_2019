<!DOCTYPE html>
<html>
	<head>
		<title>AWS S3 File System</title>
		<script src="https://sdk.amazonaws.com/js/aws-sdk-2.395.0.min.js"></script> 
		<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
		<script src="https://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	</head>
	<body>

		<ul id="objectList" ></ul>

		<br>

		<button id="sync-button">Sync</button>

		<br>

		<input id="file-chooser" type="file"/>

		<br>

		<button id="upload-button">Upload</button>

		<p id="results">
			<p></p>
		
			<br>

			<button id="download-button">Download</button>

			<br>
			
			<button id="delete-button">Delete</button>
			
			<br>
			
			<button id="rename-button">Rename</button>
			
			<br>
			
			<input type="file" id="file" />
			
			<div id="box"></div>
			
			<button id="edit-button">Edit</button>
			
			<br>
		
		
			<script type="text/javascript">
				/// <reference types="aws-sdk" />
				/// Load the SDK for JavaScript
				// var AWS = require('aws-sdk');
				//login aws by using credentials to upload
				var credentials = {
						accessKeyId: 'xxxxx',//use individual accessKeyId
						secretAccessKey: 'xxxxx'//use individual secretAccessKey
				};  

				//set region
				AWS.config.update(credentials);
				AWS.config.region = 'eu-west-2';

				

				var xhr = new XMLHttpRequest();
				var url = "http://10.40.216.211:80";
				xhr.open("POST", url, true);
				xhr.setRequestHeader("Content-Type", "application/json");
				//xhr.onreadystatechange = function () {
				//	if (xhr.readyState === 4 && xhr.status === 200) {
				//		var json = JSON.parse(xhr.responseText);
				//		console.log(json.email + ", " + json.password);
				//	}
				//};
				var data = JSON.stringify({"email": "hey@mail.com", "password": "101010"});
				xhr.send(data);
				
				
				// create bucket instance
				var bucket = new AWS.S3({params: {Bucket: 'deadlinefighters'}});//select which bucket to upload
				var fileChooser = document.getElementById('file-chooser');
				var upload = document.getElementById('upload-button');
				var download = document.getElementById('download-button');
				var del = document.getElementById('delete-button');
				var rename = document.getElementById('rename-button');
				var edit = document.getElementById('edit-button');
				var sync = document.getElementById('sync-button');
				var results = document.getElementById('results');
				upload.addEventListener('click', function () {

					var file = fileChooser.files[0];

					if (file) {
							results.innerHTML = '';
							var params = {Key: file.name, ContentType: file.type, Body: file, 'Access-Control-Allow-Credentials': '*','ACL': 'public-read'};//set the related path of bucket, set body as file, ACL as public
							bucket.upload(params, function (err, data) {
								console.log(err); //print error if failed
								results.innerHTML = err ? 'ERROR!' : 'UPLOADED.';
							});
					} 
					else {
							results.innerHTML = 'Nothing to upload.';
					}

				}, false);
				
			
				//create folder

				var fs = require('fs');		
				fs.mkdir("D:\\deadlinefighters\\",function(err){

				   if (err) {
					   return console.error(err);
				   }
				   console.log("folder created successfully.");
				});
						
				
				
				//list
				bucket.listObjects({}, function(err, data) {

					if (err) 
					{
						console.log(err, err.stack); 
					}// an error occurred

					$('#objectList').empty();   //empty the list
					var objects = data.Contents;
					  
					$.each(objects, function(i, content) {
						//successful response in console
						console.log(data);  
						//list the file name to the page
						$('#objectList').append("<button  id="+i+" value= '"+content.Key+"'>"+content.Key+"</button><br>");
					}); 
				
			  
			  
					//sync——only can download all files now, the function of upload all files are not implemented.
					$(sync).click(function(){

						var fs = require("fs"); 
						var bucket2 = 'deadlinefighters';

						fs.readdir('D:\\deadlinefighters\\',function(err,files){
							console.log(files);
							var s3_upload = new AWS.S3();

							for(var i=0;i<files.length; ++i){

								if (file){
										results.innerHTML = '';
										var params_up = {Bucket: bucket2, Key: file.name, ContentType: file.type, Body: file, 'Access-Control-Allow-Credentials': '*','ACL': 'public-read'};//set the related path of bucket, set body as file, ACL as public
										s3_upload.upload(params_up, function (err, data) {
											console.log(err); //print error if failed
											results.innerHTML = err ? 'ERROR!' : 'UPLOADED.';
										});

								} 
								else {
									results.innerHTML = 'Nothing to upload.';
								}
							}
						});
				  
						  
				  
		  				bucket.listObjects({}, function(err, data) {

							if (err){ 
								console.log(err, err.stack); // an error occurred 
							} 

							var objects = data.Contents;	  
							$.each(objects, function(i, content) {

								var fs = require('fs');	
								var file = content.Key;

								console.log(file);  

								var filePath = '/deadlinefighters'+'/' + file;

								console.log(filePath); 

								var bucket1 = 'deadlinefighters';
								var aws_download = new AWS.S3();
								var aws_delete = new AWS.S3();
								   
								var params1 = {
									Bucket: bucket1,
									Key: file
								};

								aws_download.getObject(params1, function(err, data) {

									if (err) {
										console.error(err);
									}
									else{
										fs.writeFileSync(filePath, data.Body);
										console.log("download sucessfully");
									}
								});
							});
			
						}); 
		 			});
			  
				
			  
			  
					//Select a special file to download and delete
			  		$('#objectList').on("click",'button',function(){
						var i = $(this).attr('id');
						var downloadbtn = $("<button id='download'></button>").text("download");
						var deletebtn = $("<button id='delete'></button>").text("delete");
						$(downloadbtn).dialog();
						$(deletebtn).dialog();


						var fs = require('fs');	
						var file = $(this).val();

						console.log(file);  

						var filePath = '/deadlinefighters'+'/' + file;

						console.log(filePath); 

						var bucket1 = 'deadlinefighters';
						var aws_download = new AWS.S3();
						var aws_delete = new AWS.S3();


						$(downloadbtn).click(function(){
							var params1 = {
								Bucket: bucket1,
								Key: file
							};
							aws_download.getObject(params1, function(err, data) {
								if (err) {
									console.error(err);
								}
								else {
									fs.writeFileSync(filePath, data.Body)
									//data.body.toString()
									console.log("download sucessfully");
								}
							});
				  		});

				  
						$(deletebtn).click(function(){
							var params2 = {
									Bucket: bucket1,
									Key: file
							};
							aws_delete.deleteObject(params2, function (err, data) {
								if(err){
									return console.log(err);
								}
								else {
									console.log("delete sucessfully");
								}
							});	 
				  		});
					});
				});
				

				//download		
				var fs = require('fs');		
				var FilePath1 = '/Test1！.zip';
				var bucket1 = 'deadlinefighters';
				var key1 = 'Test1！.zip';
				var download1 = new AWS.S3();

				download.addEventListener('click', function(){

					var downloadFile = (FilePath1, bucket1, key1) => {
						var params1 = {
							Bucket: bucket1,
							Key: key1
						};

						download1.getObject(params1, (err, data) => {
							if (err) console.error(err)
							fs.writeFileSync(FilePath1, data.Body.toString())
						})
					}

					downloadFile(FilePath1, bucket1, key1);		
				});
		
		
		
				//delete
				var bucket2 = 'deadlinefighters';
				var key2 = '！.txt';
				var delete1 = new AWS.S3();

				del.addEventListener('click', function(){
	
					var params2 = {
						Bucket: bucket2,
						Key: key2
					};

					delete1.deleteObject(params2, function (err, data) {
						if(err){
							return console.log(err);
						}
						else {
							console.log("delete sucessfully");
						}
					});			
				});
		
		

				//rename - first copy second delete
				var re_name = new AWS.S3();

				rename.addEventListener('click', function(){
					
						var params3 = {
							Bucket: 'deadlinefighters',
							Key: 'Test1！.zip',
						};
					
						var params4 = {
							Bucket: 'deadlinefighters',
							CopySource: '/deadlinefighters/Test1！.zip',
							Key: '2！.zip',	
						};

						re_name.copyObject(params4, function (err, data) {
				   			if (err){

				   				console.log(err, err.stack);
				   			}
				   			else { 

								console.log(data); 
						   
								re_name.deleteObject(params3, function (err, data) {
									if(err){
										return console.log(err);
									}
									else {
										console.log("rename sucessfully");
									}
								});		
						   	}
						});	
				});	
			</script>	
	</body>
</html>
