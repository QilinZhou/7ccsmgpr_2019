<!DOCTYPE html>
<html>
	<head>
		<title>AWS S3 File System</title>
		<script src="https://sdk.amazonaws.com/js/aws-sdk-2.395.0.min.js"></script> 
		<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
		<script src="https://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	</head>
	<body>

		<ul id="objectList" ></ul>

		<br>

		<button id="sync-button">Sync</button>

		<br>

		<input id="file-chooser" type="file"/>

		<br>

		<button id="upload-button">Upload</button>

		<p id="results">
			<p></p>
		
			<br>

			<button id="download-button">Download</button>

			<br>
			
			<button id="delete-button">Delete</button>
			
			<br>
			
			<button id="rename-button">Rename</button>
			
			<br>
			
			<input type="file" id="file" />
			
			<div id="box"></div>
			
			<button id="edit-button">Edit</button>
			
			<br>
		
		
			<script type="text/javascript">
				/// <reference types="aws-sdk" />
				/// Load the SDK for JavaScript
				// var AWS = require('aws-sdk');
				//login aws by using credentials to upload
				var credentials = {
						accessKeyId: 'xxxx',//use individual accessKeyId
						secretAccessKey: 'xxxx'//use individual secretAccessKey
				};  

				//set region
				AWS.config.update(credentials);
				AWS.config.region = 'eu-west-2';

				var xhr = new XMLHttpRequest();
				var url = "http://10.40.129.248:80";
				var data;
				var dir; //Local directory synced
				
				
				// create bucket instance
				var bucket = new AWS.S3({params: {Bucket: 'deadlinefighters'}});//select which bucket to upload
				var fileChooser = document.getElementById('file-chooser');
				var upload = document.getElementById('upload-button');
				var download = document.getElementById('download-button');
				var del = document.getElementById('delete-button');
				var rename = document.getElementById('rename-button');
				var edit = document.getElementById('edit-button');
				var sync = document.getElementById('sync-button');
				var results = document.getElementById('results');
				upload.addEventListener('click', function () {

					var file = fileChooser.files[0];

					if (file) {
							xhr.open("POST", url, true);
							xhr.setRequestHeader("Content-Type", "application/json");
							results.innerHTML = '';

							data = JSON.stringify({"operation": "uploadFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": file.name}});

							xhr.onreadystatechange = function () {
								if (xhr.readyState === 4 && xhr.status === 200) {
									console.log("Status code of uploadFile: " + xhr.status);
									results.innerHTML = 'UPLOADED';
								}
								else if(xhr.status!=200) {
									results.innerHTML = 'ERROR!';
								}
							};
							xhr.send(data);
					} 
					else {
							results.innerHTML = 'Nothing to upload.';
					}

				}, false);
				
			
				//create folder

				var fs = require('fs');
				var isMacLike = navigator.platform.match(/(Mac|iPhone|iPod|iPad)/i)?true:false;
				if(isMacLike){
					dir = require('os').homedir()+"/deadlinefighters";
					if(!fs.existsSync(dir)){
						fs.mkdir(dir,function(err){

						   if (err) {
							   return console.error(err);
						   }
						   console.log("folder created successfully.");
						});
					}
				}
				else{
					dir = "D:\\deadlinefighters\\";
					if(!fs.existsSync(dir)){		
						fs.mkdir(dir,function(err){

						   if (err) {
							   return console.error(err);
						   }
						   console.log("folder created successfully.");
						});
					}
				}
						
				
				
				//list
				bucket.listObjects({}, function(err, data) {

					if (err) 
					{
						console.log(err, err.stack); 
					}// an error occurred

					$('#objectList').empty();   //empty the list
					var objects = data.Contents;
					  
					$.each(objects, function(i, content) {
						//successful response in console
						console.log(data);  
						//list the file name to the page
						$('#objectList').append("<button  id="+i+" value= '"+content.Key+"'>"+content.Key+"</button><br>");
					}); 
				
			  
			  
					//sync
					$(sync).click(function(){

						var fs = require("fs"); 
						var bucket2 = 'deadlinefighters';

						fs.readdir('D:\\deadlinefighters\\',function(err,files){
							console.log(files);
							var s3_upload = new AWS.S3();
							 
                        $.each(files, function(i, filecontent) {     
	                        fs.readFile('D:\\deadlinefighters\\'+filecontent, function (err, data) {
                                if (err) {
                                    return console.error(err);
                                }
						    results.innerHTML = '';
				            var params_upload = {Bucket: bucket2, Key: filecontent, Body: data, 'Access-Control-Allow-Credentials': '*','ACL': 'public-read'};
				            s3_upload.upload(params_upload, function (err, data) {
					        console.log(err); 
					        results.innerHTML = err ? 'ERROR!' : 'UPLOADED.';
				                    });
                                });		
                            }); 
						});
				  
						  
				  
		  				bucket.listObjects({}, function(err, data) {

							if (err){ 
								console.log(err, err.stack); // an error occurred 
							} 

							var objects = data.Contents;	  
							$.each(objects, function(i, content) {

								var fs = require('fs');	
								var file = content.Key;

								console.log(file);  

								var filePath = '/deadlinefighters'+'/' + file;

								console.log(filePath); 

								var bucket1 = 'deadlinefighters';
								var aws_download = new AWS.S3();
								   
								var params1 = {
									Bucket: bucket1,
									Key: file
								};

								aws_download.getObject(params1, function(err, data) {

									if (err) {
										console.error(err);
									}
									else{
										fs.writeFileSync(filePath, data.Body);
										console.log("download sucessfully");
									}
								});
							});
			
						}); 
		 			});
			  
				
			  
			  
					//Select a special file to download and delete
			  		$('#objectList').on("click",'button',function(){
						var i = $(this).attr('id');
						var downloadbtn = $("<button id='download'></button>").text("download");
						var deletebtn = $("<button id='delete'></button>").text("delete");
						$(downloadbtn).dialog();
						$(deletebtn).dialog();


						var fs = require('fs');	
						var file = $(this).val();

						console.log(file);  

						var filePath = '/deadlinefighters'+'/' + file;

						console.log(filePath); 

						var bucket1 = 'deadlinefighters';
						var aws_delete = new AWS.S3();


						$(downloadbtn).click(function(){

								console.log("Entered downloadbtn");

								xhr.open("POST", url, true);

								xhr.setRequestHeader("Content-Type", "application/json");
								results.innerHTML = '';

								data = JSON.stringify({"operation": "downloadFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": file}});

								xhr.onreadystatechange = function () {

									if (xhr.readyState === 4 && xhr.status === 200) {
										console.log("Download successful with status code: " + xhr.status);
										results.innerHTML = 'DOWNLOADED!';
									}
									else if(xhr.status!=200) {
										results.innerHTML = 'ERROR!';
									}
								};
								xhr.send(data);
				  		});

				  
						$(deletebtn).click(function(){

								console.log("Entered deletebtn");

								xhr.open("POST", url, true);

								xhr.setRequestHeader("Content-Type", "application/json");
								results.innerHTML = '';

								data = JSON.stringify({"operation": "deleteFile", "bucketName": "deadlinefighters", "fileDetails": {"fileName": file}});

								xhr.onreadystatechange = function () {

									if (xhr.readyState === 4 && xhr.status === 200) {
										console.log("Delete successful with status code: " + xhr.status);
										results.innerHTML = 'DELETED!';
									}
									else if(xhr.status!=200) {
										results.innerHTML = 'ERROR!';
									}
								};
								xhr.send(data);
				  		});
					});
				});
		
		

				//rename - first copy second delete
				var re_name = new AWS.S3();

				rename.addEventListener('click', function(){
					
						var params3 = {
							Bucket: 'deadlinefighters',
							Key: 'Test1！.zip',
						};
					
						var params4 = {
							Bucket: 'deadlinefighters',
							CopySource: '/deadlinefighters/Test1！.zip',
							Key: '2！.zip',	
						};

						re_name.copyObject(params4, function (err, data) {
				   			if (err){

				   				console.log(err, err.stack);
				   			}
				   			else { 

								console.log(data); 
						   
								re_name.deleteObject(params3, function (err, data) {
									if(err){
										return console.log(err);
									}
									else {
										console.log("rename sucessfully");
									}
								});		
						   	}
						});	
				});	
			</script>	
	</body>
</html>
